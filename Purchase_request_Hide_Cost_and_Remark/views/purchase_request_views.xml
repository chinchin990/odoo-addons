<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- 继承采购申请的表单视图 -->
        <record id="view_purchase_request_form_inherit_custom" model="ir.ui.view">
            <field name="name">purchase.request.form.inherit.custom</field>
            <field name="model">purchase.request</field>
            <field name="inherit_id" ref="purchase_request.view_purchase_request_form"/>
            <!-- 增加优先级，确保此视图修改在其他同级修改之后应用 -->
            <field name="priority">200</field>
            <field name="arch" type="xml">

                <!-- 1. 在产品行的“已采购数量”后添加“备注”字段 -->
                <!--    使用 groups 属性，让此字段仅对“采购申请经理”组的用户可见 -->
                <xpath expr="//field[@name='line_ids']/tree/field[@name='purchased_qty']" position="after">
                    <field name="x_remark" groups="purchase_request.group_purchase_request_manager"/>
                </xpath>

                <!-- 2. 隐藏成本和价格相关信息 -->
                <!--    优化：不再使用多个 invisible 属性，而是直接用 groups 属性指定只有采购经理能看到这些元素 -->

                <!-- 隐藏产品行的“预计成本”列 -->
                <xpath expr="//field[@name='line_ids']/tree/field[@name='estimated_cost']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </xpath>
                <!-- Hide Unit Price from non-managers on PR form lines tree -->
                <xpath expr="//field[@name='line_ids']/tree/field[@name='unit_price']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </xpath>

                <!-- 隐藏表单底部的“预计成本”总计金额 -->
                <xpath expr="//field[@name='estimated_cost'][@nolabel='1']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </xpath>

                <!-- 隐藏“预计成本”总计的标签 -->
                <xpath expr="//label[@for='estimated_cost']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </xpath>

                <!-- Explicitly hide the Unit Price label for non-managers on PR line form -->
                <xpath expr="//label[@for='unit_price']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager,base.group_system</attribute>
                </xpath>
                <!-- Fallback: if there is no label node, inject a manager-only label before field -->
                <xpath expr="//group[@name='settings']//field[@name='unit_price']" position="before">
                    <label for="unit_price" groups="purchase_request.group_purchase_request_manager,base.group_system"/>
                </xpath>

                <!-- 隐藏产品行的“Show Details”按钮 -->
                <xpath expr="//field[@name='line_ids']/tree//button[@name='action_show_details']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </xpath>

                <!-- 隐藏表单头部的“明细行 (Lines)”智能按钮 -->
                <xpath expr="//button[@name='action_view_purchase_request_line']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </xpath>
            </field>
        </record>

        <!-- 继承采购申请行的表单视图 -->
        <record id="view_purchase_request_line_form_inherit_custom" model="ir.ui.view">
            <field name="name">purchase.request.line.form.inherit.custom</field>
            <field name="model">purchase.request.line</field>
            <field name="inherit_id" ref="purchase_request.purchase_request_line_form"/>
            <field name="priority">200</field>
            <field name="arch" type="xml">
                <!-- 添加备注字段，仅采购经理可见 -->
                <field name="purchased_qty" position="after">
                    <field name="x_remark" groups="purchase_request.group_purchase_request_manager"/>
                </field>
                <!-- 隐藏预计成本字段，仅采购经理可见 -->
                <field name="estimated_cost" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </field>
                <!-- Hide Unit Price from non-managers on PR line form -->
                <field name="unit_price" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </field>
            </field>
        </record>

        <!-- 继承采购申请行的列表视图 -->
        <record id="view_purchase_request_line_tree_inherit_custom" model="ir.ui.view">
            <field name="name">purchase.request.line.tree.inherit.custom</field>
            <field name="model">purchase.request.line</field>
            <field name="inherit_id" ref="purchase_request.purchase_request_line_tree"/>
            <field name="priority">200</field>
            <field name="arch" type="xml">
                <!-- 添加备注字段，仅采购经理可见 -->
                <field name="purchased_qty" position="after">
                    <field name="x_remark" groups="purchase_request.group_purchase_request_manager"/>
                </field>
                <!-- 隐藏预计成本字段，仅采购经理可见 -->
                <field name="estimated_cost" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </field>
                <!-- Note: Unit Price is not present in the base list view; no change needed here. -->
            </field>
        </record>
        
        <!-- 继承采购申请关联的采购订单行视图，隐藏单价 -->
        <record id="purchase_order_line_form2_sub_inherit_hide_price" model="ir.ui.view">
            <field name="name">purchase.order.line.form2.hide.price</field>
            <field name="model">purchase.order.line</field>
            <field name="inherit_id" ref="purchase_request.purchase_order_line_form2_sub"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='price_unit']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </xpath>
                <!-- Hide Subtotal column and its header label for non-managers -->
                <xpath expr="//field[@name='price_subtotal']" position="attributes">
                    <attribute name="groups">purchase.group_purchase_manager,base.group_system</attribute>
                </xpath>
            </field>
        </record>

        <record id="purchase_order_line_tree_sub_inherit_hide_price" model="ir.ui.view">
            <field name="name">purchase.order.line.tree.hide.price</field>
            <field name="model">purchase.order.line</field>
            <field name="inherit_id" ref="purchase_request.purchase_order_line_tree_sub"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='price_unit']" position="attributes">
                    <attribute name="groups">purchase_request.group_purchase_request_manager</attribute>
                </xpath>
            </field>
        </record>
        
        <!-- 这部分代码清空了原有动作的 context，如果不需要可以注释或删除 -->
        <record id="purchase_request.purchase_request_form_action" model="ir.actions.act_window">
            <field name="context">{}</field>
        </record>
        
    </data>
</odoo>
